// src/handlers/delete.rs
use anyhow::Result;
use crossterm::event::KeyEvent;

use crate::models::App;

pub fn handle(app: &mut App, key: KeyEvent) -> Result<bool> {
    use crossterm::event::KeyCode;

    match app.input_mode {
        crate::models::InputMode::::DeleteConfirm => {
            match key.code {
                KeyCode::Esc => {
                    app.input_mode = crate::models::InputMode::::Normal;
                    app.selected_product_for_delete = None;
                }
                KeyCode::Up | KeyCode::Down => {
                    app.delete_option = if app.delete_option == 0 { 1 } else { 0 };
                }
                KeyCode::Char('1') => app.delete_option = 0,
                KeyCode::Char('2') => app.delete_option = 1,
                KeyCode::Enter => {
                    if app.delete_option == 0 {
                        if let Some(product) = &app.selected_product_for_delete {
                            match app.api_client.delete_product(&product.sku, false) {
                                Ok(_) => {
                                    app.set_status_message(format!("Product {} deleted from database", product.sku));
                                    app.refresh_data();
                                    app.clear_selection();
                                }
                                Err(e) => {
                                    app.set_status_message(format!("Error deleting product: {}", e));
                                }
                            }
                        }
                        app.input_mode = crate::models::InputMode::::Normal;
                        app.selected_product_for_delete = None;
                    } else {
                        if let Some(product) = &app.selected_product_for_delete {
                            match crate::handlers::edit::edit_file_ops::build_file_tree(&product.sku) {
                                Ok(tree) => {
                                    app.file_tree_content = tree;
                                    app.input_mode = crate::models::InputMode::::DeleteFileConfirm;
                                }
                                Err(e) => {
                                    app.set_status_message(format!("Error scanning files: {}", e));
                                    app.input_mode = crate::models::InputMode::::Normal;
                                    app.selected_product_for_delete = None;
                                }
                            }
                        }
                    }
                }
                _ => {}
            }
            Ok(true)
        }
        crate::models::InputMode::::DeleteFileConfirm => {
            match key.code {
                crossterm::event::KeyCode::Esc => {
                    app.input_mode = crate::models::InputMode::::Normal;
                    app.selected_product_for_delete = None;
                    app.file_tree_content.clear();
                }
                crossterm::event::KeyCode::Char('y') | crossterm::event::KeyCode::Char('Y') => {
                    if let Some(product) = &app.selected_product_for_delete {
                        match app.api_client.delete_product(&product.sku, true) {
                            Ok(_) => {
                                app.set_status_message(format!("Product {} and all files deleted", product.sku));
                                app.refresh_data();
                                app.clear_selection();
                            }
                            Err(e) => {
                                app.set_status_message(format!("Error deleting product: {}", e));
                            }
                        }
                    }
                    app.input_mode = crate::models::InputMode::::Normal;
                    app.selected_product_for_delete = None;
                    app.file_tree_content.clear();
                }
                crossterm::event::KeyCode::Char('n') | crossterm::event::KeyCode::Char('N') => {
                    app.input_mode = crate::models::InputMode::::Normal;
                    app.selected_product_for_delete = None;
                    app.file_tree_content.clear();
                }
                _ => {}
            }
            Ok(true)
        }
        _ => Ok(false),
    }
}
